<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNY 2026 Ang Pow Hunt</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- Config Placeholders -->
    <script>
        // YOUR CONFIGURATION (Pre-filled)
        window.__firebase_config = '{"apiKey":"AIzaSyACTQvtejx8422cwlOskqO_HfPAeOaTe4o","authDomain":"cny-game.firebaseapp.com","projectId":"cny-game","storageBucket":"cny-game.firebasestorage.app","messagingSenderId":"753520860642","appId":"1:753520860642:web:f394ebfb1060774dde2dbb","measurementId":"G-KESDRQPJFQ"}'; 
        window.__app_id = 'cny-breakout-2026';
    </script>

    <style>
        body { margin: 0; padding: 0; background-color: #dc2626; }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-8px); }
          75% { transform: translateX(8px); }
        }
        .animate-shake {
          animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
        /* Custom Scrollbar for Leaderboard */
        .leaderboard-scroll::-webkit-scrollbar {
          width: 8px;
        }
        .leaderboard-scroll::-webkit-scrollbar-track {
          background: #7f1d1d; 
          border-radius: 4px;
        }
        .leaderboard-scroll::-webkit-scrollbar-thumb {
          background: #fbbf24; 
          border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Lock, Unlock, Clock, HelpCircle, XCircle, ArrowUp, ArrowDown, ArrowLeft, ArrowRight, 
          Zap, RotateCcw, Play, Gift, Flame, Scroll, Coins, Camera, UploadCloud, 
          MousePointerClick, CheckCircle2, Volume2, VolumeX, Music, Youtube, LayoutGrid, 
          Star, Trophy, Users, Maximize, Minimize, ExternalLink, ChevronLeft, Calculator, 
          ZoomIn, Puzzle, Video, Mail, MailOpen
        } from 'lucide-react';

        // Firebase Imports
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, addDoc, onSnapshot } from "firebase/firestore";

        // --- CONFIGURATION ---
        const YOUTUBE_VIDEO_ID = "vLxEFPyOhM4"; 

        // *** GOOGLE APPS SCRIPT URL ***
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzgNNULg3GnTPSorQXM08Dsz4bC6Kg7WlyfKcJO9RgEuFnw_GhU1i8JJBd6hpGItvCCRQ/exec"; 

        // --- FIREBASE INITIALIZATION ---
        let auth = null;
        let db = null;
        const appId = window.__app_id || 'default-app-id';

        try {
            const rawConfig = window.__firebase_config;
            if (rawConfig && rawConfig !== '{}') {
                const firebaseConfig = JSON.parse(rawConfig);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) {
            console.warn("Firebase Init Failed (Offline Mode Active):", e);
        }

        // --- SOUND SYSTEM ---
        const useAudioSystem = (isMuted) => {
          const audioContextRef = useRef(null);
          const initAudio = () => {
            try {
                if (!audioContextRef.current) {
                  audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContextRef.current.state === 'suspended') {
                  audioContextRef.current.resume();
                }
            } catch(e) { console.log("Audio init failed", e); }
          };

          const playTone = useCallback((freq, type, duration, startTime = 0, vol = 0.1) => {
            if (isMuted || !audioContextRef.current) return;
            try {
                const ctx = audioContextRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, ctx.currentTime + startTime);
                gain.gain.setValueAtTime(vol, ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + startTime + duration);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(ctx.currentTime + startTime);
                osc.stop(ctx.currentTime + startTime + duration);
            } catch(e) {}
          }, [isMuted]);

          const sounds = {
            click: () => playTone(800, 'sine', 0.1, 0, 0.05),
            error: () => { playTone(150, 'sawtooth', 0.3, 0, 0.2); playTone(100, 'sawtooth', 0.3, 0.1, 0.2); },
            success: () => { playTone(523.25, 'sine', 0.2, 0); playTone(659.25, 'sine', 0.2, 0.1); playTone(783.99, 'sine', 0.4, 0.2); },
            coin: () => { playTone(1567.98, 'sine', 0.3, 0, 0.1); playTone(2093.00, 'sine', 0.5, 0.05, 0.05); },
            win: () => { 
                const now = 0;
                playTone(261.63, 'triangle', 2.0, now, 0.3);
                playTone(329.63, 'triangle', 2.0, now + 0.1, 0.3);
                playTone(392.00, 'triangle', 2.0, now + 0.2, 0.3);
                playTone(523.25, 'sine', 3.0, now + 0.3, 0.4);
            },
            flip: () => { playTone(400, 'sine', 0.05, 0, 0.05); }
          };
          return { initAudio, sounds };
        };

        // --- CONFETTI ---
        const FireConfetti = () => {
          const canvasRef = useRef(null);
          useEffect(() => {
            const canvas = canvasRef.current;
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = [];
            const colors = ['#FBBF24', '#F59E0B', '#EF4444', '#DC2626', '#FEF3C7']; 
            for (let i = 0; i < 150; i++) {
              particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                vx: Math.random() * 2 - 1,
                vy: Math.random() * 3 + 2,
                size: Math.random() * 8 + 3,
                color: colors[Math.floor(Math.random() * colors.length)],
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 10 - 5
              });
            }
            let animationId;
            const animate = () => {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              particles.forEach((p, index) => {
                p.y += p.vy;
                p.x += p.vx;
                p.rotation += p.rotationSpeed;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate((p.rotation * Math.PI) / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                ctx.restore();
                if (p.y > canvas.height) { p.y = -20; p.x = Math.random() * canvas.width; }
              });
              animationId = requestAnimationFrame(animate);
            };
            animate();
            return () => cancelAnimationFrame(animationId);
          }, []);
          return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-50" />;
        };

        // --- INTERNAL BINGO BOARD ---
        const InternalBingoBoard = ({ onClose, sounds, db, className }) => {
          const [success, setSuccess] = useState(false);
          const [isUploading, setIsUploading] = useState(false);

          const levels = [
            { id: 'P1', color: 'bg-red-500 border-red-700', classes: ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy'] },
            { id: 'P2', color: 'bg-orange-500 border-orange-700', classes: ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy'] },
            { id: 'P3', color: 'bg-yellow-500 border-yellow-700 text-red-900', classes: ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy'] },
            { id: 'P4', color: 'bg-green-500 border-green-700', classes: ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy', 'Love'] },
            { id: 'P5', color: 'bg-blue-500 border-blue-700', classes: ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy'] },
            { id: 'P6', color: 'bg-purple-500 border-purple-700', classes: ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy'] },
          ];

          const compressImage = (file) => {
            return new Promise((resolve) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                  const canvas = document.createElement('canvas');
                  const MAX_WIDTH = 800; 
                  const scaleSize = MAX_WIDTH / img.width;
                  canvas.width = MAX_WIDTH;
                  canvas.height = img.height * scaleSize;
                  const ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  resolve(canvas.toDataURL('image/jpeg', 0.8));
                }
              }
            })
          };

          const handleUpload = async (e, tileId) => {
            if (e.target.files && e.target.files[0]) {
              setIsUploading(true);
              try {
                  const file = e.target.files[0];
                  const base64Image = await compressImage(file);
                  const uploadClassName = className || 'Unknown Class';
                  
                  if (db) {
                     await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'photo_submissions'), {
                        className: uploadClassName,
                        tileId: tileId,
                        image: base64Image,
                        timestamp: new Date().toISOString()
                     });
                  }

                  if (GAS_WEB_APP_URL) {
                      await fetch(GAS_WEB_APP_URL, {
                          method: 'POST',
                          mode: 'no-cors', 
                          body: JSON.stringify({
                              image: base64Image,
                              className: uploadClassName,
                              tileId: tileId
                          })
                      });
                  }

                  sounds.coin();
                  setSuccess(true);
              } catch (error) {
                  console.error("Upload failed", error);
                  alert("Upload failed. Please try again.");
              } finally {
                  setIsUploading(false);
              }
            }
          };

          return (
            <div className="fixed inset-0 z-50 bg-red-50 overflow-y-auto animate-in fade-in slide-in-from-bottom-10 duration-300 flex flex-col">
              <div className="sticky top-0 bg-white/90 backdrop-blur-md shadow-md z-40 p-4 flex justify-between items-center border-b-4 border-red-200">
                <h2 className="text-2xl md:text-3xl font-black text-red-600 tracking-tight">Chinese New Year Class Photos</h2>
                <button onClick={onClose} className="flex items-center gap-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold px-4 py-2 rounded-xl transition-colors">
                  <ChevronLeft /> Back to Game
                </button>
              </div>
              <div className="flex-grow p-4 md:p-8">
                <div className="max-w-[1600px] mx-auto">
                  <p className="text-center text-slate-500 text-lg mb-8">Click your class tile to upload your photo and reveal the secret code!</p>
                  
                  {isUploading && (
                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                        <div className="bg-white p-6 rounded-2xl flex flex-col items-center">
                            <div className="w-12 h-12 border-4 border-red-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p className="font-bold text-red-600">Uploading Photo...</p>
                        </div>
                    </div>
                  )}

                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6">
                    {levels.map((level) => (
                      <div key={level.id} className="flex flex-col gap-3">
                        <div className={`${level.color} text-white font-black text-3xl text-center py-4 rounded-xl shadow-md border-b-4 border-black/20`}>{level.id}</div>
                        <div className="flex flex-col gap-3">
                          {level.classes.map((cls) => (
                            <label key={`${level.id}-${cls}`} className="relative group cursor-pointer">
                              <input type="file" accept="image/*" className="hidden" onChange={(e) => handleUpload(e, `${level.id}-${cls}`)} />
                              <div className="bg-white border-2 border-slate-200 border-b-4 border-b-slate-300 rounded-xl p-4 flex flex-col items-center justify-center transition-all group-hover:-translate-y-1 group-hover:border-red-300 group-hover:shadow-lg active:translate-y-0 active:border-b-2 h-24">
                                <Camera className="w-6 h-6 text-slate-300 mb-1 group-hover:text-red-400" />
                                <span className="font-bold text-slate-600 group-hover:text-red-600">{cls}</span>
                              </div>
                            </label>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              {success && (
                <div className="fixed inset-0 z-[60] bg-black/60 flex items-center justify-center p-4 animate-in fade-in">
                  <div className="bg-white rounded-[2rem] p-8 max-w-md w-full text-center shadow-2xl border-4 border-green-500 animate-in zoom-in duration-300 relative">
                    <button onClick={() => setSuccess(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><XCircle /></button>
                    <div className="text-6xl mb-4">üßß</div>
                    <h3 className="text-3xl font-black text-green-600 mb-2">Photo Uploaded!</h3>
                    <p className="text-slate-500 mb-6 font-bold">Here is your unlocking code:</p>
                    <div className="bg-slate-100 border-2 border-slate-300 rounded-xl p-4 mb-6"><span className="font-mono text-4xl font-black text-slate-800 tracking-widest select-all">CNY2026</span></div>
                    <button onClick={onClose} className="w-full bg-green-500 hover:bg-green-600 text-white font-black text-xl py-4 rounded-xl transition-transform hover:scale-105 shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1">RETURN TO UNLOCK</button>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // --- PUZZLE MODAL ---
        const PuzzleModal = ({ lock, onClose, onUnlock, sounds, db, className }) => {
            const [inputValue, setInputValue] = useState('');
            const [sequence, setSequence] = useState([]); 
            const [error, setError] = useState(false);
            const [showHint, setShowHint] = useState(false);
            const [showInternalBingo, setShowInternalBingo] = useState(false);
            const [isImageZoomed, setIsImageZoomed] = useState(false);
            
            // Memory Game State
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [solved, setSolved] = useState([]);

            if (!lock) return null;

            useEffect(() => {
                setInputValue('');
                setSequence([]);
                setError(false);
                setShowHint(false);
                setShowInternalBingo(false);
                setIsImageZoomed(false);

                if (lock.type === 'memory') {
                const symbols = [
                    { id: 'horse', icon: <Flame size={32} /> },
                    { id: 'coin', icon: <Coins size={32} /> },
                    { id: 'gift', icon: <Gift size={32} /> },
                    { id: 'luck', icon: <Star size={32} /> }
                ];
                const deck = [...symbols, ...symbols].map((item, index) => ({ ...item, uniqueId: index }));
                // Simple Shuffle
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
                setCards(deck);
                setFlipped([]);
                setSolved([]);
                }
            }, [lock]);

            const handleSubmit = (e) => {
                if (e) e.preventDefault();
                let isCorrect = false;
                if (lock.type === 'text' || lock.type === 'numeric' || lock.type === 'bingo_launch') {
                    if (inputValue.toUpperCase().trim() === lock.answer.toUpperCase()) isCorrect = true;
                } 
                else if (lock.type === 'directional' || lock.type === 'color') {
                    if (JSON.stringify(sequence) === JSON.stringify(lock.answer)) isCorrect = true;
                }
                if (isCorrect) onUnlock(lock.id);
                else { sounds.error(); setError(true); setSequence([]); setTimeout(() => setError(false), 500); }
            };

            const handleSequenceInput = (val) => {
                sounds.click();
                const newSeq = [...sequence, val];
                setSequence(newSeq);
                if (newSeq.length === lock.answer.length) {
                    setTimeout(() => {
                        if (JSON.stringify(newSeq) === JSON.stringify(lock.answer)) onUnlock(lock.id);
                        else { sounds.error(); setError(true); setSequence([]); setTimeout(() => setError(false), 500); }
                    }, 300);
                }
            };

            const handleCardClick = (index) => {
                if (flipped.length === 2 || flipped.includes(index) || solved.includes(cards[index].id)) return;
                sounds.flip();
                const newFlipped = [...flipped, index];
                setFlipped(newFlipped);
                if (newFlipped.length === 2) {
                    const card1 = cards[newFlipped[0]];
                    const card2 = cards[newFlipped[1]];
                    if (card1.id === card2.id) {
                        setTimeout(() => {
                        sounds.coin();
                        setSolved([...solved, card1.id]);
                        setFlipped([]);
                        if (solved.length + 1 === cards.length / 2) setTimeout(() => onUnlock(lock.id), 800);
                        }, 500);
                    } else {
                        setTimeout(() => setFlipped([]), 1000);
                    }
                }
            };

            if (showInternalBingo) {
                return <InternalBingoBoard onClose={() => setShowInternalBingo(false)} sounds={sounds} db={db} className={className} />;
            }

            return (
                <div className="fixed inset-0 z-40 flex items-center justify-center p-4 bg-red-900/90 backdrop-blur-sm animate-in fade-in duration-200">
                <div className={`relative bg-red-800 border-4 border-yellow-500/50 w-full max-w-4xl rounded-[3rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] ${error ? 'animate-shake border-red-500 shadow-[0_0_30px_rgba(239,68,68,0.6)]' : ''}`}>
                    <div className="bg-red-900/50 p-6 border-b-4 border-red-700 flex justify-between items-center flex-shrink-0">
                    <div className="flex items-center gap-4">
                        <div className="text-yellow-400 p-2 bg-red-900 rounded-full">{lock.icon}</div>
                        <h3 className="font-black text-2xl md:text-3xl text-yellow-100 font-serif">{lock.title}</h3>
                    </div>
                    <button onClick={onClose} className="text-red-300 hover:text-white transition-colors p-2 hover:bg-red-700 rounded-full"><XCircle size={32} /></button>
                    </div>

                    <div className="p-6 overflow-y-auto flex-1">
                    <p className="text-xl md:text-2xl text-white mb-6 font-bold leading-relaxed text-center drop-shadow-md whitespace-pre-line">{lock.clue}</p>

                    {lock.video && (
                        <div className="flex justify-center mb-6 relative group">
                        <iframe width="560" height="315" src={`https://www.youtube.com/embed/${lock.video}?start=1`} title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen className="rounded-2xl shadow-xl border-4 border-yellow-500 max-h-[40vh] w-full object-contain"></iframe>
                        </div>
                    )}

                    {lock.image && (
                        <div className="flex justify-center mb-6 relative group">
                        <img src={lock.image} alt="Clue" onClick={() => setIsImageZoomed(true)} className="rounded-2xl shadow-xl border-4 border-yellow-500 max-h-[40vh] object-contain bg-black/20 cursor-zoom-in transition-transform hover:scale-[1.02]" />
                        <div className="absolute bottom-2 bg-black/60 text-white text-xs px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Click to Enlarge</div>
                        </div>
                    )}

                    {lock.link && (
                        <div className="flex justify-center mb-6">
                            <a href={lock.link} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 bg-yellow-500 hover:bg-yellow-400 text-red-900 font-black text-xl py-3 px-6 rounded-2xl transition-transform hover:scale-105 shadow-xl border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1">
                            <ExternalLink size={24} /> SOLVE PUZZLE
                            </a>
                        </div>
                    )}

                    {(lock.type === 'text' || lock.type === 'numeric' || lock.type === 'bingo_launch') && (
                        <div className="space-y-6 max-w-xl mx-auto">
                        {lock.type === 'bingo_launch' && (
                            <div className="flex justify-center mb-4">
                            <button onClick={() => setShowInternalBingo(true)} className="flex items-center gap-3 bg-yellow-500 hover:bg-yellow-400 text-red-900 font-black text-xl py-3 px-6 rounded-2xl transition-transform hover:scale-105 shadow-xl border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1">
                                <ExternalLink size={24} /> CNY CLASS PHOTO
                            </button>
                            </div>
                        )}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input autoFocus type={lock.type === 'numeric' ? 'tel' : 'text'} value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder={lock.type === 'bingo_launch' ? "ENTER CODE..." : "ANSWER..."} className="w-full bg-red-900 border-4 border-red-600 rounded-2xl px-6 py-4 text-4xl text-center text-yellow-100 placeholder-red-400 focus:outline-none focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 transition-all font-black uppercase tracking-widest" />
                            <button type="submit" className="w-full bg-gradient-to-r from-yellow-500 to-yellow-400 hover:from-yellow-400 hover:to-yellow-300 text-red-900 font-black text-2xl py-4 rounded-2xl transition-all shadow-lg border-b-8 border-yellow-600 active:border-b-0 active:translate-y-2">COLLECT RED PACKET</button>
                        </form>
                        </div>
                    )}

                    {lock.type === 'directional' && (
                        <div className="space-y-6">
                        <div className="flex justify-center gap-4 mb-2 h-10">
                            {sequence.map((dir, i) => (
                            <span key={i} className="text-yellow-400 font-black text-3xl drop-shadow-md animate-in zoom-in">
                                {dir === 'UP' && <ArrowUp size={32} />}
                                {dir === 'DOWN' && <ArrowDown size={32} />}
                                {dir === 'LEFT' && <ArrowLeft size={32} />}
                                {dir === 'RIGHT' && <ArrowRight size={32} />}
                            </span>
                            ))}
                        </div>
                        <div className="grid grid-cols-3 gap-3 max-w-[250px] mx-auto">
                            <div />
                            <button onClick={() => handleSequenceInput('UP')} className="p-4 bg-red-700 hover:bg-yellow-500 hover:text-red-900 text-yellow-100 rounded-xl flex items-center justify-center transition-colors shadow-lg active:scale-95 border-b-4 border-red-900"><ArrowUp size={32} /></button>
                            <div />
                            <button onClick={() => handleSequenceInput('LEFT')} className="p-4 bg-red-700 hover:bg-yellow-500 hover:text-red-900 text-yellow-100 rounded-xl flex items-center justify-center transition-colors shadow-lg active:scale-95 border-b-4 border-red-900"><ArrowLeft size={32} /></button>
                            <button onClick={() => handleSequenceInput('DOWN')} className="p-4 bg-red-700 hover:bg-yellow-500 hover:text-red-900 text-yellow-100 rounded-xl flex items-center justify-center transition-colors shadow-lg active:scale-95 border-b-4 border-red-900"><ArrowDown size={32} /></button>
                            <button onClick={() => handleSequenceInput('RIGHT')} className="p-4 bg-red-700 hover:bg-yellow-500 hover:text-red-900 text-yellow-100 rounded-xl flex items-center justify-center transition-colors shadow-lg active:scale-95 border-b-4 border-red-900"><ArrowRight size={32} /></button>
                        </div>
                        </div>
                    )}

                    {lock.type === 'color' && (
                        <div className="space-y-6">
                        <div className="flex justify-center gap-3 mb-2 h-8">
                            {sequence.map((col, i) => (
                            <div key={i} className={`w-6 h-6 rounded-full bg-${col}-500 ring-4 ring-white/20 shadow-[0_0_15px_currentColor] animate-in zoom-in`} style={{backgroundColor: col === 'yellow' ? '#EAB308' : '#EF4444'}} />
                            ))}
                        </div>
                        <div className="flex justify-center gap-6">
                            <button onClick={() => handleSequenceInput('red')} className="w-32 h-32 rounded-2xl transform transition-all active:scale-95 hover:scale-105 shadow-xl border-b-8 border-red-800 bg-red-500 flex flex-col items-center justify-center gap-2 group">
                                <div className="text-white font-black text-xl group-hover:scale-110 transition-transform">RED</div>
                            </button>
                            <button onClick={() => handleSequenceInput('yellow')} className="w-32 h-32 rounded-2xl transform transition-all active:scale-95 hover:scale-105 shadow-xl border-b-8 border-yellow-600 bg-yellow-400 flex flex-col items-center justify-center gap-2 group">
                                <div className="text-red-900 font-black text-xl group-hover:scale-110 transition-transform">GOLD</div>
                            </button>
                        </div>
                        </div>
                    )}

                    {lock.type === 'memory' && (
                        <div className="grid grid-cols-4 gap-3 max-w-xl mx-auto">
                        {cards.map((card, index) => {
                            const isFlipped = flipped.includes(index) || solved.includes(card.id);
                            return (
                            <button key={index} onClick={() => handleCardClick(index)} className={`aspect-square rounded-xl flex items-center justify-center shadow-lg transition-all duration-300 transform perspective-1000 border-b-8 ${isFlipped ? 'bg-yellow-100 text-red-600 rotate-y-180 border-yellow-300' : 'bg-red-700 border-red-900 hover:bg-red-600 hover:-translate-y-1'}`}>
                                {isFlipped ? <div className="animate-in zoom-in spin-in-180 duration-300 scale-150">{card.icon}</div> : <div className="text-yellow-500/30 text-3xl font-serif font-bold">Á¶è</div>}
                            </button>
                            );
                        })}
                        </div>
                    )}

                    <div className="mt-6 pt-4 border-t-2 border-red-700/50 flex justify-center">
                        {!showHint ? (
                        <button onClick={() => { sounds.click(); setShowHint(true); }} className="flex items-center gap-2 text-red-300 hover:text-yellow-300 text-lg mx-auto transition-colors font-bold px-4 py-2 rounded-full hover:bg-red-900/50">
                            <HelpCircle size={20} /> Need a hint?
                        </button>
                        ) : (
                        <div className="bg-yellow-900/40 border-2 border-yellow-500/30 rounded-xl p-4 text-center animate-in fade-in max-w-md">
                            <p className="text-yellow-400 text-lg font-bold">HINT: {lock.hint}</p>
                        </div>
                        )}
                    </div>
                    </div>
                </div>

                {isImageZoomed && (
                    <div className="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200 cursor-zoom-out" onClick={() => setIsImageZoomed(false)}>
                        <div className="relative max-w-full max-h-full">
                            <img src={lock.image} alt="Clue Fullscreen" className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" />
                            <p className="text-white text-center mt-4 font-bold text-lg animate-pulse">Tap to close</p>
                        </div>
                    </div>
                )}
                </div>
            );
        };

        // --- APP COMPONENT ---
        const App = () => {
          const [gameState, setGameState] = useState('start');
          const [timer, setTimer] = useState(0);
          const [activeLockId, setActiveLockId] = useState(null);
          const [isMuted, setIsMuted] = useState(false);
          const [isFullScreen, setIsFullScreen] = useState(false);
          const [user, setUser] = useState(null);
          const [className, setClassName] = useState('');
          const [leaderboard, setLeaderboard] = useState([]);
          const [hasSubmitted, setHasSubmitted] = useState(false);
          const containerRef = useRef(null);
          
          const { initAudio, sounds } = useAudioSystem(isMuted);

          useEffect(() => {
            if(auth) {
                const unsubscribe = onAuthStateChanged(auth, setUser);
                signInAnonymously(auth).catch(e => {
                    console.error("Authentication Error:", e);
                    // Don't alert user as auth might be optional/silent
                });
                return () => unsubscribe();
            }
          }, []);

          useEffect(() => {
            if (!db) return;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            const unsubscribe = onSnapshot(q, (snapshot) => {
              const data = snapshot.docs.map(doc => doc.data());
              setLeaderboard(data.sort((a, b) => a.time - b.time).slice(0, 10));
            }, (e) => {
                console.error("Leaderboard Error:", e);
                // alert("Leaderboard failed to load. Check console."); 
            });
            return () => unsubscribe();
          }, []);

          // --- GAME DATA ---
          const [locks, setLocks] = useState([
            { id: 1, type: 'numeric', title: 'Jigsaw House', clue: 'What is the unit number of the house?', hint: 'Solve the jigsaw puzzle to see the number.', answer: '6820', isLocked: true, icon: <Puzzle className="w-12 h-12" />, link: 'https://www.jigsawplanet.com/?rc=play&pid=214cf9e0a4a7' },
            { id: 2, type: 'numeric', title: 'Horse Math', clue: 'Solve the equation in the picture!', hint: 'Remember: Multiplication before Subtraction.', answer: '20', isLocked: true, icon: <Calculator className="w-12 h-12" />, image: 'https://i.imgur.com/iF4CtBB.png' },
            { id: 3, type: 'directional', title: 'Lion Dance', clue: 'Repeat the steps using the arrow keys.', hint: 'A total of 5 moves.', answer: ['DOWN', 'UP', 'LEFT', 'RIGHT', 'LEFT'], isLocked: true, icon: <Zap className="w-12 h-12" />, vimeoId: '1164377353' },
            { id: 4, type: 'color', title: 'Lucky Colors', clue: 'Tap order: Lantern, Coin, Firecracker, Ingot.', hint: 'Red, Yellow, Red, Yellow', answer: ['red', 'yellow', 'red', 'yellow'], isLocked: true, icon: <Scroll className="w-12 h-12" /> },
            { id: 5, type: 'numeric', title: 'Festive Video', clue: 'Watch the video and add the two answers together:\n1. How many times did you hear "gong xi"?\n2. How many types of zodiac animals appeared?', hint: 'Not all the animals in the video are in the Chinese zodiac.', answer: '19', isLocked: true, icon: <Video className="w-12 h-12" />, video: 'fS1MyAGXaKg' },
            { id: 6, type: 'text', title: 'The Greeting', clue: 'Finish: "Gong Xi Fa ___"', hint: 'Rhymes with "Eye".', answer: 'CAI', isLocked: true, icon: <Gift className="w-12 h-12" /> },
            { id: 7, type: 'bingo_launch', title: 'Class Photo', clue: 'Upload a Class Photo with "Heart" signs ‚ù§Ô∏è on the CNY Class Photo page. Enter the code you receive!', hint: 'No photo, no code.', answer: 'CNY2026', isLocked: true, icon: <Camera className="w-12 h-12" /> },
            { id: 8, type: 'memory', title: 'Fortune Match', clue: 'Find all matching pairs!', hint: '4 pairs to find.', answer: 'MEMORY_SOLVED', isLocked: true, icon: <LayoutGrid className="w-12 h-12" /> }
          ]);

          useEffect(() => {
            let interval;
            if (gameState === 'playing') {
              interval = setInterval(() => { setTimer(t => t + 1); }, 1000);
            }
            return () => clearInterval(interval);
          }, [gameState]);

          useEffect(() => {
            if (locks.every(l => !l.isLocked) && gameState === 'playing') {
              setGameState('won');
              sounds.win();
              // Saving score logic
              if (!hasSubmitted && className && db) {
                setHasSubmitted(true);
                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), { className: className, time: timer, timestamp: new Date().toISOString() })
                    .catch(e => {
                        console.error("Save error:", e);
                        alert("Error saving score to database!");
                    });
              }
            }
          }, [locks, gameState, className, hasSubmitted, timer]);

          const toggleFullScreen = () => {
            const el = containerRef.current;
            if (!document.fullscreenElement) {
                if (el.requestFullscreen) el.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
          };

          const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
          };

          const handleStart = () => {
            if (!className.trim()) { alert("Please enter your Class Name to start!"); return; }
            initAudio(); 
            sounds.click();
            setGameState('playing');
            setTimer(0);
          };

          const handleUnlock = (id) => {
            sounds.success();
            setLocks(prev => prev.map(lock => lock.id === id ? { ...lock, isLocked: false } : lock));
            setActiveLockId(null);
          };

          return (
            <div ref={containerRef} className="min-h-screen bg-red-600 text-white font-sans selection:bg-yellow-400 selection:text-red-900 overflow-hidden relative">
              
              {!isMuted && gameState !== 'start' && (
                <div className="fixed top-0 left-0 w-[1px] h-[1px] opacity-[0.01] overflow-hidden pointer-events-none z-0">
                  <iframe width="100%" height="100%" src={`https://www.youtube.com/embed/${YOUTUBE_VIDEO_ID}?autoplay=1&loop=1&playlist=${YOUTUBE_VIDEO_ID}&controls=0&enablejsapi=1&version=3`} title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowFullScreen></iframe>
                </div>
              )}

              <div className="fixed top-4 right-4 z-50 flex items-center gap-3">
                <button onClick={toggleFullScreen} className="p-4 rounded-full bg-red-800/90 border-2 border-yellow-400 text-yellow-400 hover:bg-red-700 transition-colors shadow-xl" title="Toggle Full Screen">
                  {isFullScreen ? <Minimize size={32} /> : <Maximize size={32} />}
                </button>
                <button onClick={() => setIsMuted(!isMuted)} className="p-4 rounded-full bg-red-800/90 border-2 border-yellow-400 text-yellow-400 hover:bg-red-700 transition-colors shadow-xl" title="Toggle Sound">
                  {isMuted ? <VolumeX size={32} /> : <Volume2 size={32} />}
                </button>
              </div>

              <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-orange-500 rounded-full blur-[120px] opacity-60" />
                <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-yellow-500 rounded-full blur-[120px] opacity-40" />
                <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#FCD34D 1px, transparent 1px)', backgroundSize: '30px 30px'}}></div>
              </div>

              {gameState === 'start' && (
                <div className="relative z-10 flex flex-col items-center justify-center min-h-screen p-6 text-center">
                  <div className="mb-10 p-12 bg-red-800/90 backdrop-blur-xl border-4 border-yellow-500/50 rounded-[3rem] shadow-2xl max-w-3xl w-full animate-in fade-in zoom-in duration-500">
                    <div className="flex justify-center mb-8"><div className="bg-yellow-500/20 p-8 rounded-full border-4 border-yellow-500 shadow-[0_0_40px_rgba(245,158,11,0.6)]"><Flame size={80} className="text-yellow-400" /></div></div>
                    <h1 className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-yellow-300 via-yellow-400 to-orange-500 mb-4 tracking-tight drop-shadow-sm leading-tight">CNY 2026</h1>
                    <p className="text-3xl font-serif text-yellow-200/90 italic mb-8">Collect all 8 Red Packets to win!</p>
                    <p className="text-2xl text-red-200 mb-8 font-bold">For a better experience, click the square icon in the top right corner to go full screen.</p>
                    <div className="bg-red-900/50 p-6 rounded-2xl mb-8 border-2 border-red-700">
                       <label className="block text-red-200 text-xl font-bold mb-2 uppercase tracking-wider">Enter Class Name</label>
                       <input type="text" value={className} onChange={(e) => setClassName(e.target.value)} placeholder="e.g. 4 CARE" className="w-full text-center text-4xl font-black text-yellow-400 bg-red-800 border-b-4 border-yellow-500 focus:outline-none focus:border-yellow-300 py-2 placeholder-red-700/50 uppercase" />
                    </div>
                    <button onClick={handleStart} className={`group relative w-full flex items-center justify-center gap-4 bg-gradient-to-r from-yellow-500 to-yellow-400 hover:from-yellow-400 hover:to-yellow-300 text-red-900 px-12 py-8 rounded-[2rem] font-black text-4xl transition-all shadow-[0_8px_30px_rgba(234,179,8,0.4)] border-b-8 border-yellow-600 active:border-b-0 active:translate-y-2 ${!className ? 'opacity-50 cursor-not-allowed grayscale' : 'hover:scale-[1.02]'}`}>
                      <Play className="fill-current w-10 h-10" /> START GAME
                    </button>
                  </div>
                </div>
              )}

              {gameState === 'playing' && (
                <div className="relative z-10 container mx-auto px-4 py-8 max-w-7xl h-screen flex flex-col">
                  <header className="flex justify-between items-center mb-8 bg-red-800/80 backdrop-blur-md p-6 rounded-3xl border-2 border-red-500 shadow-xl">
                    <div className="flex items-center gap-4">
                      <div className="bg-yellow-500/20 p-3 rounded-xl border-2 border-yellow-500/40 animate-pulse"><Users className="w-6 h-6 text-yellow-400" /></div>
                      <div className="flex flex-col"><span className="font-serif text-3xl font-bold tracking-widest text-yellow-200 leading-none">RED PACKET HUNT</span><span className="text-red-300 text-sm font-bold tracking-wider">PLAYER: {className}</span></div>
                    </div>
                    <div className="flex items-center gap-3 font-mono text-4xl font-bold text-yellow-400"><Clock className="w-8 h-8" />{formatTime(timer)}</div>
                  </header>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-6 flex-grow content-center pb-8">
                    {locks.map((lock) => (
                      <button key={lock.id} onClick={() => { if (lock.isLocked) { sounds.click(); setActiveLockId(lock.id); } }} disabled={!lock.isLocked} className={`relative group flex flex-col items-center justify-center p-6 rounded-[2rem] border-4 transition-all duration-300 h-full min-h-[180px] ${!lock.isLocked ? 'bg-yellow-500/20 border-yellow-500 shadow-[0_0_30px_rgba(234,179,8,0.3)]' : 'bg-red-800 border-red-700 hover:border-yellow-400 hover:bg-red-700 hover:scale-[1.05] hover:shadow-2xl cursor-pointer'}`}>
                        <div className={`mb-4 p-5 rounded-full transition-colors duration-500 ${!lock.isLocked ? 'bg-yellow-500 text-red-900' : 'bg-red-900 text-red-200 group-hover:bg-yellow-500/20 group-hover:text-yellow-400'}`}>
                          {lock.isLocked ? <Mail size={48} /> : <MailOpen size={48} className="animate-in zoom-in" />}
                        </div>
                        <h3 className={`font-black text-2xl mb-1 text-center leading-tight ${!lock.isLocked ? 'text-yellow-400' : 'text-white'}`}>{!lock.isLocked ? 'COLLECTED!' : lock.title}</h3>
                        <div className="absolute top-5 right-5"><div className={`w-5 h-5 rounded-full ${!lock.isLocked ? 'bg-yellow-500 shadow-[0_0_15px_rgba(234,179,8,1)]' : 'bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.8)]'}`} /></div>
                      </button>
                    ))}
                  </div>
                  <div className="text-center text-red-100 text-3xl font-black font-serif drop-shadow-sm">{locks.filter(l => !l.isLocked).length} / {locks.length} RED PACKETS COLLECTED</div>
                </div>
              )}

              {activeLockId && <PuzzleModal lock={locks.find(l => l.id === activeLockId)} onClose={() => { sounds.click(); setActiveLockId(null); }} onUnlock={handleUnlock} sounds={sounds} db={db} className={className} />}

              {gameState === 'won' && (
                <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-red-700/95 backdrop-blur-xl animate-in fade-in duration-1000 overflow-y-auto py-10">
                  <FireConfetti />
                  <div className="relative z-10 w-full max-w-4xl mx-auto px-4 flex flex-col items-center">
                    <div className="bg-red-800/90 border-4 border-yellow-500/50 rounded-[3rem] shadow-2xl p-8 mb-8 w-full max-w-2xl text-center transform scale-100 animate-in zoom-in-50 duration-500">
                      <div className="inline-flex p-6 rounded-full bg-yellow-500/20 mb-6 border-4 border-yellow-500 shadow-[0_0_60px_rgba(234,179,8,0.5)]"><div className="text-yellow-400 font-black text-6xl">üßß</div></div>
                      <h2 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-500 mb-2 tracking-tighter">HUNT COMPLETE!</h2>
                      <p className="text-2xl text-yellow-200/90 font-serif italic mb-6">Congratulations, {className}!</p>
                      <div className="bg-red-900/50 rounded-2xl p-4 border-2 border-red-700 inline-flex items-center gap-4"><span className="text-red-200 font-bold">Your Time:</span><span className="font-mono text-3xl text-white font-black">{formatTime(timer)}</span></div>
                    </div>
                    <div className="bg-red-900/80 border-2 border-red-600 rounded-[2rem] p-8 w-full shadow-2xl">
                      <div className="flex items-center justify-center gap-3 mb-6"><Trophy className="text-yellow-400 w-8 h-8" /><h3 className="text-3xl font-black text-yellow-400 tracking-wider">LEADERBOARD</h3><Trophy className="text-yellow-400 w-8 h-8" /></div>
                      <div className="overflow-hidden rounded-xl border-2 border-red-700">
                        <table className="w-full text-left">
                          <thead className="bg-red-800 text-red-200"><tr><th className="p-4 font-bold text-center w-20">Rank</th><th className="p-4 font-bold">Class Name</th><th className="p-4 font-bold text-right">Time</th></tr></thead>
                          <tbody className="divide-y divide-red-800 bg-red-900/50">
                            {leaderboard.length === 0 ? (<tr><td colSpan="3" className="p-8 text-center text-red-400 italic">No scores yet. Be the first!</td></tr>) : (leaderboard.map((entry, index) => (
                              <tr key={index} className={entry.className === className && entry.time === timer ? "bg-yellow-500/20" : ""}>
                                <td className="p-4 text-center font-black text-xl text-red-300">{index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : index + 1}</td>
                                <td className="p-4 font-bold text-lg text-white">{entry.className}{entry.className === className && entry.time === timer && <span className="ml-2 text-xs bg-yellow-500 text-red-900 px-2 py-1 rounded-full">YOU</span>}</td>
                                <td className="p-4 text-right font-mono text-xl text-yellow-400">{formatTime(entry.time)}</td>
                              </tr>
                            )))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <button onClick={() => window.location.reload()} className="mt-8 flex items-center justify-center gap-3 bg-red-600 hover:bg-red-500 text-white px-8 py-4 rounded-xl font-black text-xl transition-colors border-b-4 border-red-800 active:border-b-0 active:translate-y-1"><RotateCcw size={24} /> PLAY AGAIN</button>
                  </div>
                </div>
              )}
            </div>
          );
        }
        
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>








